<div class="tab-pane fade" id="fee-payment" role="tabpanel">
    <h2>Fee Payment</h2>
    <div id="fee-info">
        <p>Monthly Mess Fee Due Day: <span id="mess-fee-due-day"></span></p>
        <p>Monthly Mess Fee: Rs.<span id="mess-fee"></span></p>
        <p>Yearly Hostel Rent Due Date: <span id="rent-due-date"></span></p>
        <p>Yearly Hostel Rent: Rs.<span id="rent-fee"></span></p>
    </div>
    <h3>Upcoming Payments</h3>
    <table class="table">
        <thead>
            <tr>
                <th>Due Date</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="upcoming-payments">
            <!-- Upcoming payments will be populated here -->
        </tbody>
    </table>
</div>
<script src="https://js.stripe.com/v3/"></script>
<script>
$(document).ready(function () {
    function loadFeeInfo() {
        $.ajax({
            url: '/student/get_fee_info',
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    $('#mess-fee-due-day').text(response.feeInfo.messFeeDay);
                    $('#mess-fee').text(response.feeInfo.messFee.toFixed(2));
                    $('#rent-due-date').text(response.feeInfo.rentDueDate);
                    $('#rent-fee').text(response.feeInfo.rentFee.toFixed(2));

                    const upcomingPayments = $('#upcoming-payments');
                    upcomingPayments.empty();
                    response.feeInfo.upcomingPayments.forEach(function (payment) {
                        const totalAmount = payment.amount + payment.lateAmount;
                        const payNowButton = `<button class="btn btn-primary btn-sm pay-now" data-amount="${totalAmount}" data-description="${payment.description}">Pay Now</button>`;
                        upcomingPayments.append(`
                        <tr>
                            <td>${new Date(payment.dueDate).toLocaleDateString()}</td>
                            <td>${payment.description}</td>
                            <td>₹${payment.amount.toFixed(2)}</td>
                            <td>₹${payment.lateAmount.toFixed(2)}</td>
                            <td>₹${totalAmount.toFixed(2)}</td>
                            <td>${payment.status}</td>
                            <td>${payNowButton}</td>
                        </tr>
                    `);
                    });
                } else {
                    alert('Failed to load fee information: ' + response.message);
                }
            },
            error: function () {
                alert('An error occurred while loading fee information.');
            }
        });
    }

    loadFeeInfo();

    $(document).on('click', '.pay-now', function() {
        const amount = $(this).data('amount');
        const description = $(this).data('description');
        
        $.ajax({
            url: '/create-checkout-session',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                amount: amount,
                description: description
            }),
            success: function(response) {
                if (response.success) {
                    window.location.href = response.checkoutUrl;
                } else {
                    alert('Failed to create checkout session: ' + response.message);
                }
            },
            error: function() {
                alert('An error occurred while creating the checkout session.');
            }
        });
    });
});
</script>
